name: UI And API Testing Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    name: ðŸŽ¨ UI Tests

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@v2.1.0
      
    - name: Setup gradlew
      run: chmod +x gradlew
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Run UI Tests
      env:
        GITHUB_ACTIONS: "true"
        CI: "true"
      run: |
        echo "ðŸš€ Menjalankan UI Tests..."
        ./gradlew clean test --tests "ui.runner.CucumberTestRunner" --info
      
    - name: Generate Allure Report for UI Tests
      if: always()
      run: |
        echo "ðŸ“Š Generating Allure Report for UI Tests..."
        ./gradlew allureReport
      
    - name: Upload UI Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-reports
        path: |
          build/reports/tests/test/
          build/allure-results/
          build/test-results/test/
          build/reports/allure-report/
        retention-days: 30

    - name: Generate UI Test Summary
      if: always()
      run: |
        echo "## ðŸŽ¨ UI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Initialize variables
        TOTAL_TESTS=0
        FAILED_TESTS=0
        
        if [ -d "build/test-results/test" ]; then
          # Count tests from XML files
          for xml_file in build/test-results/test/*.xml; do
            if [ -f "$xml_file" ]; then
              TESTS=$(grep -o 'tests="[^"]*"' "$xml_file" | head -1 | sed 's/tests="//' | sed 's/"//')
              FAILURES=$(grep -o 'failures="[^"]*"' "$xml_file" | head -1 | sed 's/failures="//' | sed 's/"//')
              
              # Convert to numbers, default to 0 if empty
              TESTS=${TESTS:-0}
              FAILURES=${FAILURES:-0}
              
              TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
              FAILED_TESTS=$((FAILED_TESTS + FAILURES))
            fi
          done
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "ðŸ“Š **Total Tests:** $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Passed Tests:** $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Failed Tests:** $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILED_TESTS -eq 0 ] && [ $TOTAL_TESTS -gt 0 ]; then
            echo "**Status:** âœ… All UI tests passed!" >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_TESTS -eq 0 ]; then
            echo "**Status:** âš ï¸ No tests were executed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ $FAILED_TESTS test(s) failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**Status:** âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Reports available for download in Artifacts section:**" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Reports: \`ui-test-reports/reports/tests/test/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Allure Report: \`ui-test-reports/reports/allure-report/\`" >> $GITHUB_STEP_SUMMARY
        echo "- JUnit XML: \`ui-test-reports/test-results/test/\`" >> $GITHUB_STEP_SUMMARY
  
  api-tests:
    runs-on: ubuntu-latest
    name: ðŸ”Œ API Tests
    needs: ui-tests
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
      
    - name: Setup gradlew
      run: chmod +x gradlew

    - name: Setup API Environment
      run: |
        echo "ðŸ”§ Setting up API test environment..."
        # Set default API key jika secret tidak tersedia
        if [ -z "${{ secrets.REQRES_API_KEY }}" ]; then
          echo "REQRES_API_KEY not found in secrets, using default"
          echo "API_KEY=reqres-free-v1" >> $GITHUB_ENV
        else
          echo "API_KEY=${{ secrets.REQRES_API_KEY }}" >> $GITHUB_ENV
        fi
        echo "BASE_URL=https://reqres.in/api" >> $GITHUB_ENV

    - name: Run API Tests
      run: |
        echo "ðŸ”‘ API Key: ${API_KEY:0:3}***${API_KEY: -4}"
        echo "ðŸŒ Base URL: $BASE_URL"
        echo "ðŸš€ Menjalankan API Tests..."
        
        # Jalankan API tests saja
        ./gradlew clean test --tests "api.tests.*" --info --stacktrace
        
        # Check exit code
        if [ $? -eq 0 ]; then
          echo "âœ… API tests completed successfully"
        else
          echo "âŒ API tests failed, but continuing with report generation"
        fi
      
    - name: Generate Allure Report for API Tests
      if: always()
      run: |
        echo "ðŸ“Š Generating Allure Report for API Tests..."
        ./gradlew allureReport
      
    - name: Generate API Test Summary
      if: always()
      run: |
        echo "ðŸ“Š Generating API Test Summary..."
        
        # Create summary file
        SUMMARY_FILE="build/api-test-summary.md"
        echo "# ðŸ“Š API Test Execution Report" > $SUMMARY_FILE
        echo "" >> $SUMMARY_FILE
        echo "## Execution Details" >> $SUMMARY_FILE
        echo "- **Execution Time:** $(date)" >> $SUMMARY_FILE
        echo "- **API Base URL:** $BASE_URL" >> $SUMMARY_FILE
        echo "- **API Key Used:** ${API_KEY:0:3}***${API_KEY: -4}" >> $SUMMARY_FILE
        echo "" >> $SUMMARY_FILE
        
        # Count tests from all XML files
        if [ -d "build/test-results/test" ]; then
          TOTAL_TESTS=0
          FAILED_TESTS=0
          SKIPPED_TESTS=0
          
          for xml_file in build/test-results/test/*.xml; do
            if [ -f "$xml_file" ]; then
              TESTS=$(grep -o 'tests="[^"]*"' "$xml_file" | head -1 | sed 's/tests="//' | sed 's/"//')
              FAILURES=$(grep -o 'failures="[^"]*"' "$xml_file" | head -1 | sed 's/failures="//' | sed 's/"//')
              SKIPPED=$(grep -o 'skipped="[^"]*"' "$xml_file" | head -1 | sed 's/skipped="//' | sed 's/"//')
              
              # Convert to numbers, default to 0 if empty
              TESTS=${TESTS:-0}
              FAILURES=${FAILURES:-0}
              SKIPPED=${SKIPPED:-0}
              
              TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
              FAILED_TESTS=$((FAILED_TESTS + FAILURES))
              SKIPPED_TESTS=$((SKIPPED_TESTS + SKIPPED))
            fi
          done
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS))
          
          echo "## Test Results" >> $SUMMARY_FILE
          echo "- **Total Tests:** $TOTAL_TESTS" >> $SUMMARY_FILE
          echo "- **Passed Tests:** $PASSED_TESTS" >> $SUMMARY_FILE
          echo "- **Failed Tests:** $FAILED_TESTS" >> $SUMMARY_FILE
          echo "- **Skipped Tests:** $SKIPPED_TESTS" >> $SUMMARY_FILE
          
          if [ $TOTAL_TESTS -gt 0 ]; then
            if [ $PASSED_TESTS -gt 0 ]; then
              SUCCESS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
              echo "- **Success Rate:** $SUCCESS_RATE%" >> $SUMMARY_FILE
            else
              echo "- **Success Rate:** 0%" >> $SUMMARY_FILE
            fi
          else
            echo "- **Success Rate:** 0%" >> $SUMMARY_FILE
          fi
          
          # List failed tests
          if [ $FAILED_TESTS -gt 0 ]; then
            echo "" >> $SUMMARY_FILE
            echo "## âŒ Failed Tests" >> $SUMMARY_FILE
            for xml_file in build/test-results/test/*.xml; do
              if [ -f "$xml_file" ] && grep -q "failure" "$xml_file"; then
                TEST_NAME=$(basename "$xml_file" .xml | sed 's/TEST-//')
                FAILURE_COUNT=$(grep -o 'failures="[^"]*"' "$xml_file" | head -1 | sed 's/failures="//' | sed 's/"//')
                FAILURE_COUNT=${FAILURE_COUNT:-0}
                echo "- **$TEST_NAME** ($FAILURE_COUNT failures)" >> $SUMMARY_FILE
              fi
            done
          fi
          
          # List all test files
          echo "" >> $SUMMARY_FILE
          echo "## ðŸ“‹ All Test Files" >> $SUMMARY_FILE
          for xml_file in build/test-results/test/*.xml; do
            if [ -f "$xml_file" ]; then
              FILE_SIZE=$(stat -c%s "$xml_file" 2>/dev/null || stat -f%z "$xml_file" 2>/dev/null || echo "0")
              HUMAN_SIZE=$(numfmt --to=iec --suffix=B $FILE_SIZE 2>/dev/null || echo "${FILE_SIZE}B")
              TEST_NAME=$(basename "$xml_file" .xml | sed 's/TEST-//')
              echo "- $TEST_NAME.xml ($HUMAN_SIZE)" >> $SUMMARY_FILE
            fi
          done
        else
          echo "## âŒ No Test Results Found" >> $SUMMARY_FILE
          echo "No test results were generated. Please check the test execution logs." >> $SUMMARY_FILE
        fi
        
        # Create zip archive of reports
        echo "ðŸ“¦ Creating report archive..."
        cd build
        if [ -d "reports" ] || [ -d "test-results" ] || [ -d "allure-results" ]; then
          zip -r api-test-reports.zip reports/ test-results/ allure-results/ api-test-summary.md 2>/dev/null || {
            echo "Warning: Could not create zip archive"
            # Create tar as fallback
            tar -czf api-test-reports.tar.gz reports/ test-results/ allure-results/ api-test-summary.md 2>/dev/null || true
          }
        fi
        cd ..
      
    - name: Upload API Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-reports
        path: |
          build/reports/
          build/test-results/
          build/allure-results/
          build/api-test-summary.md
          build/api-test-reports.zip
          build/api-test-reports.tar.gz
        retention-days: 30
        if-no-files-found: warn

    - name: Generate API Test Summary in Actions
      if: always()
      run: |
        echo "## ðŸ”Œ API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/api-test-summary.md" ]; then
          # Extract test results section
          echo "ðŸ“Š **Test Summary:**" >> $GITHUB_STEP_SUMMARY
          grep -E "^- \*\*(Total|Passed|Failed|Skipped) Tests|^- \*\*Success Rate" build/api-test-summary.md >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ“Š **Status:** Report generation in progress..." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Download API Test Reports:**" >> $GITHUB_STEP_SUMMARY
        echo "- Complete Archive: \`api-test-reports.zip\` or \`api-test-reports.tar.gz\`" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Reports: \`reports/tests/test/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Test Summary: \`api-test-summary.md\`" >> $GITHUB_STEP_SUMMARY
        echo "- Allure Report: \`reports/allure-report/\`" >> $GITHUB_STEP_SUMMARY
  
  generate-combined-report:
    runs-on: ubuntu-latest
    name: ðŸ“Š Combined Report
    needs: [ui-tests, api-tests]
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Download UI Test Reports
      uses: actions/download-artifact@v4
      with:
        name: ui-test-reports
        path: ui-reports/

    - name: Download API Test Reports
      uses: actions/download-artifact@v4
      with:
        name: api-test-reports
        path: api-reports/

    - name: Create Combined Directory Structure
      run: |
        echo "ðŸ“Š Creating combined report structure..."
        
        # Create combined directory
        mkdir -p combined-report
        mkdir -p combined-report/ui
        mkdir -p combined-report/api
        
        # Copy UI reports
        if [ -d "ui-reports" ]; then
          echo "ðŸ“‚ Copying UI reports..."
          find ui-reports -type f -name "*.html" -o -name "*.xml" -o -name "*.json" -o -name "*.md" | head -20 | while read file; do
            cp --parents "$file" combined-report/ui/ 2>/dev/null || true
          done
        fi
        
        # Copy API reports
        if [ -d "api-reports" ]; then
          echo "ðŸ“‚ Copying API reports..."
          find api-reports -type f -name "*.html" -o -name "*.xml" -o -name "*.json" -o -name "*.md" | head -20 | while read file; do
            cp --parents "$file" combined-report/api/ 2>/dev/null || true
          done
        fi
        
        # Create simple index.html
        cat > combined-report/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Combined Test Reports</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                    margin: 0;
                    padding: 20px;
                    background-color: #f5f5f5;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                h1 {
                    color: #333;
                    border-bottom: 3px solid #007acc;
                    padding-bottom: 10px;
                }
                .section {
                    margin: 30px 0;
                    padding: 20px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                }
                .ui-section {
                    border-left: 5px solid #4CAF50;
                }
                .api-section {
                    border-left: 5px solid #2196F3;
                }
                .report-link {
                    display: inline-block;
                    padding: 10px 20px;
                    margin: 10px 5px;
                    background: #007acc;
                    color: white;
                    text-decoration: none;
                    border-radius: 5px;
                    transition: background 0.3s;
                }
                .report-link:hover {
                    background: #005a99;
                }
                .summary {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    margin: 10px 0;
                }
                .timestamp {
                    color: #666;
                    font-size: 0.9em;
                    margin-bottom: 20px;
                }
                pre {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    overflow-x: auto;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ðŸš€ Combined Test Execution Report</h1>
                <div class="timestamp">Generated on: $(date)</div>
                
                <div class="section ui-section">
                    <h2>ðŸŽ¨ UI Test Reports</h2>
                    <div class="summary">
                        <p>UI test execution completed. Download full reports from GitHub Actions Artifacts.</p>
                    </div>
                    <div>
                        <a href="ui/reports/allure-report/index.html" class="report-link" target="_blank">ðŸ“Š View Allure Report</a>
                        <a href="ui/reports/tests/test/index.html" class="report-link" target="_blank">ðŸ“„ View HTML Report</a>
                    </div>
                </div>
                
                <div class="section api-section">
                    <h2>ðŸ”Œ API Test Reports</h2>
                    <div class="summary">
                        <p>API test execution completed. Download full reports from GitHub Actions Artifacts.</p>
                    </div>
                    <div>
                        <a href="api/reports/allure-report/index.html" class="report-link" target="_blank">ðŸ“Š View Allure Report</a>
                        <a href="api/reports/tests/test/index.html" class="report-link" target="_blank">ðŸ“„ View HTML Report</a>
                        <a href="api/api-test-summary.md" class="report-link" target="_blank">ðŸ“‹ View Summary</a>
                    </div>
                </div>
                
                <div class="section">
                    <h2>ðŸ“‹ How to Download Full Reports</h2>
                    <ol>
                        <li>Go to GitHub Actions tab in your repository</li>
                        <li>Click on this workflow run</li>
                        <li>Scroll to the "Artifacts" section</li>
                        <li>Download the artifacts you need:
                            <ul>
                                <li><strong>ui-test-reports</strong> - Complete UI test results</li>
                                <li><strong>api-test-reports</strong> - Complete API test results</li>
                                <li><strong>combined-test-reports</strong> - This combined report</li>
                            </ul>
                        </li>
                    </ol>
                </div>
                
                <div class="section">
                    <h2>âš¡ Quick Commands</h2>
                    <pre>
# Download all artifacts using GitHub CLI
gh run download $RUN_ID

# Or download specific artifact
gh run download $RUN_ID -n ui-test-reports
gh run download $RUN_ID -n api-test-reports
                    </pre>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        # Create zip archive
        echo "ðŸ“¦ Creating combined report archive..."
        zip -r combined-test-reports.zip combined-report/ 2>/dev/null || {
          echo "Creating tar.gz as fallback..."
          tar -czf combined-test-reports.tar.gz combined-report/ 2>/dev/null || true
        }

    - name: Upload Combined Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: combined-test-reports
        path: |
          combined-report/
          combined-test-reports.zip
          combined-test-reports.tar.gz
        retention-days: 30

    - name: Generate Final Summary
      if: always()
      run: |
        echo "## ðŸ“Š Test Execution Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ‰ All tests have been executed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Available Reports in Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check and list available reports
        if [ -d "ui-reports" ]; then
          echo "- ðŸŽ¨ **ui-test-reports** - Complete UI test results with Allure reports" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "api-reports" ]; then
          echo "- ðŸ”Œ **api-test-reports** - Complete API test results with detailed summary" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "combined-report" ]; then
          echo "- ðŸ“Š **combined-test-reports** - Combined report with quick access links" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ Quick Links:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **[Download All Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})**" >> $GITHUB_STEP_SUMMARY
        echo "2. View detailed execution logs for debugging" >> $GITHUB_STEP_SUMMARY
        echo "3. Check HTML reports for visual test results" >> $GITHUB_STEP_SUMMARY
        echo "4. View Allure reports for interactive test analysis" >> $GITHUB_STEP_SUMMARY
