name: UI And API Testing Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    name: üé® UI Tests

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@v2.1.0
      
    - name: Setup gradlew
      run: chmod +x gradlew
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Run UI Tests with Allure
      env:
        GITHUB_ACTIONS: "true"
        CI: "true"
      run: |
        echo "üöÄ Menjalankan UI Tests dengan Allure..."
        ./gradlew clean test allureReport --tests "ui.runner.CucumberTestRunner" --info
      
    - name: Upload UI Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-reports
        path: |
          build/reports/tests/test/
          build/allure-results/
          build/test-results/test/
          build/reports/allure-report/
        retention-days: 30

    - name: Generate UI Test Summary
      if: always()
      run: |
        echo "## üé® UI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "build/test-results/test" ]; then
          TOTAL_TESTS=$(find build/test-results/test -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'tests="[^"]*"' | sed 's/tests="//' | sed 's/"//' | awk '{sum+=$1} END {print sum}')
          FAILED_TESTS=$(find build/test-results/test -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'failures="[^"]*"' | sed 's/failures="//' | sed 's/"//' | awk '{sum+=$1} END {print sum}')
          
          if [ -z "$TOTAL_TESTS" ]; then
            TOTAL_TESTS=0
          fi
          if [ -z "$FAILED_TESTS" ]; then
            FAILED_TESTS=0
          fi
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "üìä **Total Tests:** $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Passed Tests:** $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "‚ùå **Failed Tests:** $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILED_TESTS -eq 0 ] && [ $TOTAL_TESTS -gt 0 ]; then
            echo "**Status:** ‚úÖ All UI tests passed!" >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_TESTS -eq 0 ]; then
            echo "**Status:** ‚ö†Ô∏è No tests were executed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ‚ùå $FAILED_TESTS test(s) failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**Status:** ‚ö†Ô∏è No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìÅ **Reports available for download in Artifacts section:**" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Reports: \`build/reports/tests/test/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Allure Report: \`build/reports/allure-report/\`" >> $GITHUB_STEP_SUMMARY
        echo "- JUnit XML: \`build/test-results/test/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Allure Results: \`build/allure-results/\`" >> $GITHUB_STEP_SUMMARY
  
  api-tests:
    runs-on: ubuntu-latest
    name: üîå API Tests
    needs: ui-tests
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
      
    - name: Setup gradlew
      run: chmod +x gradlew

    - name: Setup API Environment
      run: |
        echo "üîß Setting up API test environment..."
        # Set default API key jika secret tidak tersedia
        if [ -z "${{ secrets.REQRES_API_KEY }}" ]; then
          echo "REQRES_API_KEY not found in secrets, using default"
          echo "API_KEY=reqres-free-v1" >> $GITHUB_ENV
        else
          echo "API_KEY=${{ secrets.REQRES_API_KEY }}" >> $GITHUB_ENV
        fi
        echo "BASE_URL=https://reqres.in/api" >> $GITHUB_ENV

    - name: Run API Tests with Allure
      run: |
        echo "üîë API Key: ${API_KEY:0:3}***${API_KEY: -4}"
        echo "üåê Base URL: $BASE_URL"
        echo "üöÄ Menjalankan API Tests dengan Allure..."
        
        # Jalankan test dan generate allure report sekaligus
        ./gradlew clean test allureReport --tests "api.tests.*" --info --stacktrace
        
        # Check exit code
        if [ $? -eq 0 ]; then
          echo "‚úÖ API tests completed successfully"
        else
          echo "‚ùå API tests failed, but continuing with report generation"
        fi
      
    - name: Generate API Test Summary
      if: always()
      run: |
        echo "üìä Generating API Test Summary..."
        
        # Create summary file
        SUMMARY_FILE="build/api-test-summary.md"
        echo "# üìä API Test Execution Report" > $SUMMARY_FILE
        echo "" >> $SUMMARY_FILE
        echo "## Execution Details" >> $SUMMARY_FILE
        echo "- **Execution Time:** $(date)" >> $SUMMARY_FILE
        echo "- **API Base URL:** $BASE_URL" >> $SUMMARY_FILE
        echo "- **API Key Used:** ${API_KEY:0:3}***${API_KEY: -4}" >> $SUMMARY_FILE
        echo "" >> $SUMMARY_FILE
        
        # Count tests from all XML files
        if [ -d "build/test-results/test" ]; then
          TOTAL_TESTS=0
          FAILED_TESTS=0
          
          for xml_file in build/test-results/test/*.xml; do
            if [ -f "$xml_file" ]; then
              TESTS=$(grep -o 'tests="[^"]*"' "$xml_file" | sed 's/tests="//' | sed 's/"//')
              FAILURES=$(grep -o 'failures="[^"]*"' "$xml_file" | sed 's/failures="//' | sed 's/"//')
              
              TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
              FAILED_TESTS=$((FAILED_TESTS + FAILURES))
            fi
          done
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "## Test Results" >> $SUMMARY_FILE
          echo "- **Total Tests:** $TOTAL_TESTS" >> $SUMMARY_FILE
          echo "- **Passed Tests:** $PASSED_TESTS" >> $SUMMARY_FILE
          echo "- **Failed Tests:** $FAILED_TESTS" >> $SUMMARY_FILE
          
          if [ $TOTAL_TESTS -gt 0 ]; then
            echo "- **Success Rate:** $((PASSED_TESTS * 100 / TOTAL_TESTS))%" >> $SUMMARY_FILE
          else
            echo "- **Success Rate:** 0%" >> $SUMMARY_FILE
          fi
          
          # List failed tests
          if [ $FAILED_TESTS -gt 0 ]; then
            echo "" >> $SUMMARY_FILE
            echo "## ‚ùå Failed Tests" >> $SUMMARY_FILE
            for xml_file in build/test-results/test/*.xml; do
              if [ -f "$xml_file" ] && grep -q "failure" "$xml_file"; then
                TEST_NAME=$(basename "$xml_file" .xml | sed 's/TEST-//')
                echo "- $TEST_NAME" >> $SUMMARY_FILE
              fi
            done
          fi
          
          # List all test files
          echo "" >> $SUMMARY_FILE
          echo "## üìã All Test Files" >> $SUMMARY_FILE
          for xml_file in build/test-results/test/*.xml; do
            if [ -f "$xml_file" ]; then
              TEST_NAME=$(basename "$xml_file" .xml | sed 's/TEST-//')
              echo "- $TEST_NAME.xml" >> $SUMMARY_FILE
            fi
          done
        else
          echo "## ‚ùå No Test Results Found" >> $SUMMARY_FILE
          echo "No test results were generated. Please check the test execution logs." >> $SUMMARY_FILE
        fi
        
        # Create zip archive of reports
        echo "üì¶ Creating report archive..."
        cd build
        if [ -d "reports" ] || [ -d "test-results" ] || [ -d "allure-results" ]; then
          zip -r api-test-reports.zip reports/ test-results/ allure-results/ api-test-summary.md 2>/dev/null || echo "Warning: Could not create zip archive"
        fi
        cd ..
      
    - name: Upload API Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-reports
        path: |
          build/reports/
          build/test-results/
          build/allure-results/
          build/api-test-summary.md
          build/api-test-reports.zip
        retention-days: 30
        if-no-files-found: warn

    - name: Generate API Test Summary in Actions
      if: always()
      run: |
        echo "## üîå API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/api-test-summary.md" ]; then
          # Extract test results section
          grep -A 6 "## Test Results" build/api-test-summary.md | tail -5 >> $GITHUB_STEP_SUMMARY
        else
          echo "üìä **Status:** Report generation in progress..." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìÅ **Download API Test Reports:**" >> $GITHUB_STEP_SUMMARY
        echo "- Complete Archive: \`api-test-reports/api-test-reports.zip\`" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Reports: \`api-test-reports/reports/tests/test/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Test Summary: \`api-test-reports/api-test-summary.md\`" >> $GITHUB_STEP_SUMMARY
        echo "- Allure Report: \`api-test-reports/reports/allure-report/\`" >> $GITHUB_STEP_SUMMARY
  
  generate-combined-report:
    runs-on: ubuntu-latest
    name: üìä Combined Report
    needs: [ui-tests, api-tests]
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Download UI Test Reports
      uses: actions/download-artifact@v4
      with:
        name: ui-test-reports
        path: ui-reports/

    - name: Download API Test Reports
      uses: actions/download-artifact@v4
      with:
        name: api-test-reports
        path: api-reports/

    - name: Create Combined Directory Structure
      run: |
        echo "üìä Creating combined report structure..."
        
        # Create combined directory
        mkdir -p combined-report
        mkdir -p combined-report/ui
        mkdir -p combined-report/api
        
        # Copy UI reports
        if [ -d "ui-reports" ]; then
          echo "üìÇ Copying UI reports..."
          cp -r ui-reports/* combined-report/ui/ 2>/dev/null || true
        fi
        
        # Copy API reports
        if [ -d "api-reports" ]; then
          echo "üìÇ Copying API reports..."
          cp -r api-reports/* combined-report/api/ 2>/dev/null || true
        fi
        
        # Create simple index.html
        cat > combined-report/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Combined Test Reports</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                    margin: 0;
                    padding: 20px;
                    background-color: #f5f5f5;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                h1 {
                    color: #333;
                    border-bottom: 3px solid #007acc;
                    padding-bottom: 10px;
                }
                .section {
                    margin: 30px 0;
                    padding: 20px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                }
                .ui-section {
                    border-left: 5px solid #4CAF50;
                }
                .api-section {
                    border-left: 5px solid #2196F3;
                }
                .report-link {
                    display: inline-block;
                    padding: 10px 20px;
                    margin: 10px 5px;
                    background: #007acc;
                    color: white;
                    text-decoration: none;
                    border-radius: 5px;
                    transition: background 0.3s;
                }
                .report-link:hover {
                    background: #005a99;
                }
                .summary {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    margin: 10px 0;
                }
                .timestamp {
                    color: #666;
                    font-size: 0.9em;
                    margin-bottom: 20px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ Combined Test Execution Report</h1>
                <div class="timestamp">Generated on: $(date)</div>
                
                <div class="section ui-section">
                    <h2>üé® UI Test Reports</h2>
                    <div class="summary">
                        <p>UI test execution completed. Download reports from the Artifacts section.</p>
                    </div>
                    <div>
                        <a href="ui/" class="report-link">üìÅ Open UI Reports</a>
                        <a href="ui/reports/allure-report/" class="report-link">üìä View Allure Report</a>
                    </div>
                </div>
                
                <div class="section api-section">
                    <h2>üîå API Test Reports</h2>
                    <div class="summary">
                        <p>API test execution completed. Download reports from the Artifacts section.</p>
                    </div>
                    <div>
                        <a href="api/" class="report-link">üìÅ Open API Reports</a>
                        <a href="api/reports/allure-report/" class="report-link">üìä View Allure Report</a>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìã How to Download Reports</h2>
                    <ol>
                        <li>Go to GitHub Actions tab</li>
                        <li>Click on this workflow run</li>
                        <li>Scroll to the "Artifacts" section</li>
                        <li>Download the artifacts you need:
                            <ul>
                                <li><strong>ui-test-reports</strong> - UI test results</li>
                                <li><strong>api-test-reports</strong> - API test results</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        # Create zip archive
        echo "üì¶ Creating combined report archive..."
        zip -r combined-test-reports.zip combined-report/

    - name: Upload Combined Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: combined-test-reports
        path: |
          combined-report/
          combined-test-reports.zip
        retention-days: 30

    - name: Generate Final Summary
      if: always()
      run: |
        echo "## üìä Test Execution Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéâ All tests have been executed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìÅ Available Reports in Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact | Description | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------------|------|" >> $GITHUB_STEP_SUMMARY
        
        # Calculate sizes (approximate)
        if [ -d "ui-reports" ]; then
          UI_SIZE=$(du -sh ui-reports | cut -f1)
          echo "| üé® **ui-test-reports** | UI test results with Allure reports | $UI_SIZE |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d "api-reports" ]; then
          API_SIZE=$(du -sh api-reports | cut -f1)
          echo "| üîå **api-test-reports** | API test results with Allure reports | $API_SIZE |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "combined-test-reports.zip" ]; then
          COMBINED_SIZE=$(du -h combined-test-reports.zip | cut -f1)
          echo "| üìä **combined-test-reports** | All reports combined in one archive | $COMBINED_SIZE |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚ö° Quick Links:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **[Download All Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})**" >> $GITHUB_STEP_SUMMARY
        echo "2. View test execution logs for debugging" >> $GITHUB_STEP_SUMMARY
        echo "3. Check individual test results in the HTML reports" >> $GITHUB_STEP_SUMMARY
