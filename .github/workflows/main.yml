name: UI And API Testing Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    name: ğŸ¨ UI Tests

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@v2.1.0
      
    - name: Setup gradlew
      run: chmod +x gradlew
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Run UI Tests
      env:
        GITHUB_ACTIONS: "true"
        CI: "true"
      run: |
        echo "ğŸš€ Menjalankan UI Tests..."
        ./gradlew clean test --tests "ui.runner.CucumberTestRunner" --info
      
    - name: Generate UI Test Report
      if: always()
      run: |
        echo "ğŸ“Š Generating UI Test Reports..."
        ./gradlew allureReport --tests "ui.runner.CucumberTestRunner"
      
    - name: Upload UI Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-reports
        path: |
          build/reports/tests/test/
          build/allure-results/
          build/test-results/test/
        retention-days: 30

    - name: Generate UI Test Summary
      if: always()
      run: |
        echo "## ğŸ¨ UI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "build/test-results/test" ]; then
          TOTAL_TESTS=$(find build/test-results/test -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'tests="[^"]*"' | sed 's/tests="//' | sed 's/"//' | awk '{sum+=$1} END {print sum}')
          FAILED_TESTS=$(find build/test-results/test -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'failures="[^"]*"' | sed 's/failures="//' | sed 's/"//' | awk '{sum+=$1} END {print sum}')
          
          if [ -z "$TOTAL_TESTS" ]; then
            TOTAL_TESTS=0
          fi
          if [ -z "$FAILED_TESTS" ]; then
            FAILED_TESTS=0
          fi
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "ğŸ“Š **Total Tests:** $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Passed Tests:** $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Failed Tests:** $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILED_TESTS -eq 0 ] && [ $TOTAL_TESTS -gt 0 ]; then
            echo "**Status:** âœ… All UI tests passed!" >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_TESTS -eq 0 ]; then
            echo "**Status:** âš ï¸ No tests were executed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ $FAILED_TESTS test(s) failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**Status:** âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ **Reports available for download in Artifacts section:**" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Reports: \`ui-test-reports\`" >> $GITHUB_STEP_SUMMARY
        echo "- Allure Results: \`ui-test-reports/allure-results/\`" >> $GITHUB_STEP_SUMMARY
        echo "- JUnit XML: \`ui-test-reports/test-results/\`" >> $GITHUB_STEP_SUMMARY
  
  api-tests:
    runs-on: ubuntu-latest
    name: ğŸ”Œ API Tests
    needs: ui-tests
    if: always()  # Jalankan meski UI tests gagal

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
      
    - name: Setup gradlew
      run: chmod +x gradlew

    - name: Setup API Environment
      run: |
        echo "ğŸ”§ Setting up API test environment..."
        # Set default API key jika secret tidak tersedia
        if [ -z "${{ secrets.REQRES_API_KEY }}" ]; then
          echo "REQRES_API_KEY not found in secrets, using default"
          echo "API_KEY=reqres-free-v1" >> $GITHUB_ENV
        else
          echo "API_KEY=${{ secrets.REQRES_API_KEY }}" >> $GITHUB_ENV
        fi
        echo "BASE_URL=https://reqres.in/api" >> $GITHUB_ENV

    - name: Run API Tests
      run: |
        echo "ğŸ”‘ API Key: ${API_KEY:0:3}***${API_KEY: -4}"
        echo "ğŸŒ Base URL: $BASE_URL"
        echo "ğŸš€ Menjalankan API Tests..."
        
        # Enable detailed logging
        ./gradlew clean test --tests "api.tests.*" --info --stacktrace || {
          echo "âŒ API tests failed"
          # Continue to generate reports even if tests fail
        }
      
    - name: Generate API Test Report
      if: always()
      run: |
        echo "ğŸ“Š Generating API Test Reports..."
        ./gradlew allureReport --tests "api.tests.*"
        
        # Create summary file
        echo "# ğŸ“Š API Test Execution Report" > build/api-test-summary.md
        echo "" >> build/api-test-summary.md
        echo "## Execution Details" >> build/api-test-summary.md
        echo "- **Execution Time:** $(date)" >> build/api-test-summary.md
        echo "- **API Base URL:** $BASE_URL" >> build/api-test-summary.md
        echo "- **API Key Used:** ${API_KEY:0:3}***${API_KEY: -4}" >> build/api-test-summary.md
        echo "" >> build/api-test-summary.md
        
        # Count tests
        if [ -d "build/test-results/test" ]; then
          TOTAL_TESTS=$(find build/test-results/test -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'tests="[^"]*"' | sed 's/tests="//' | sed 's/"//' | awk '{sum+=$1} END {print sum}')
          FAILED_TESTS=$(find build/test-results/test -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'failures="[^"]*"' | sed 's/failures="//' | sed 's/"//' | awk '{sum+=$1} END {print sum}')
          
          if [ -z "$TOTAL_TESTS" ]; then
            TOTAL_TESTS=0
          fi
          if [ -z "$FAILED_TESTS" ]; then
            FAILED_TESTS=0
          fi
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "## Test Results" >> build/api-test-summary.md
          echo "- **Total Tests:** $TOTAL_TESTS" >> build/api-test-summary.md
          echo "- **Passed Tests:** $PASSED_TESTS" >> build/api-test-summary.md
          echo "- **Failed Tests:** $FAILED_TESTS" >> build/api-test-summary.md
          echo "- **Success Rate:** $((PASSED_TESTS * 100 / TOTAL_TESTS))%" >> build/api-test-summary.md
          
          if [ $FAILED_TESTS -gt 0 ]; then
            echo "" >> build/api-test-summary.md
            echo "## âŒ Failed Tests" >> build/api-test-summary.md
            find build/test-results/test -name "*.xml" -exec grep -l "failure" {} \; | while read file; do
              CLASS_NAME=$(basename "$file" .xml)
              echo "- $CLASS_NAME" >> build/api-test-summary.md
            done
          fi
        fi
        
        # Create zip archive
        echo "ğŸ“¦ Creating report archive..."
        cd build && zip -r api-test-reports.zip reports/ test-results/ allure-results/ api-test-summary.md 2>/dev/null || true && cd ..
      
    - name: Upload API Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-reports
        path: |
          build/reports/tests/test/
          build/test-results/test/
          build/allure-results/
          build/api-test-summary.md
          build/api-test-reports.zip
        retention-days: 30
        if-no-files-found: error

    - name: Upload HTML Report Preview
      if: always()
      uses: actions/upload-pages-artifact@v3
      with:
        name: api-html-report
        path: build/reports/tests/test/

    - name: Generate API Test Summary
      if: always()
      run: |
        echo "## ğŸ”Œ API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/api-test-summary.md" ]; then
          # Extract summary from generated file
          grep -A 5 "## Test Results" build/api-test-summary.md | tail -4 >> $GITHUB_STEP_SUMMARY
        else
          echo "ğŸ“Š **Status:** Report generation in progress..." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ **API Test Reports:**" >> $GITHUB_STEP_SUMMARY
        echo "- Complete Archive: \`api-test-reports.zip\`" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Reports: \`api-test-reports/\`" >> $GITHUB_STEP_SUMMARY
        echo "- Test Summary: \`api-test-summary.md\`" >> $GITHUB_STEP_SUMMARY
        
        # Check if tests passed
        if [ -f "build/test-results/test/TEST-api.tests.GetUserTest.xml" ]; then
          if grep -q "failure" "build/test-results/test/TEST-api.tests.GetUserTest.xml"; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Some API tests failed. Check the detailed report for more information.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All API tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          fi
        fi
  
  generate-combined-report:
    runs-on: ubuntu-latest
    name: ğŸ“Š Combined Report
    needs: [ui-tests, api-tests]
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Download UI Test Reports
      uses: actions/download-artifact@v4
      with:
        name: ui-test-reports
        path: ui-reports/

    - name: Download API Test Reports
      uses: actions/download-artifact@v4
      with:
        name: api-test-reports
        path: api-reports/

    - name: Generate Combined Report
      run: |
        echo "ğŸ“Š Generating Combined Test Report..."
        
        # Create combined report directory
        mkdir -p combined-report
        
        # Copy all reports
        cp -r ui-reports/* combined-report/ 2>/dev/null || true
        cp -r api-reports/* combined-report/ 2>/dev/null || true
        
        # Create index.html
        cat > combined-report/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Combined Test Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                .success { background-color: #d4edda; border-color: #c3e6cb; }
                .failed { background-color: #f8d7da; border-color: #f5c6cb; }
                .nav { margin: 20px 0; }
                .nav a { margin-right: 15px; text-decoration: none; color: #007bff; }
            </style>
        </head>
        <body>
            <h1>ğŸš€ Combined Test Execution Report</h1>
            <p>Generated on: $(date)</p>
            
            <div class="nav">
                <a href="#ui">ğŸ¨ UI Tests</a>
                <a href="#api">ğŸ”Œ API Tests</a>
                <a href="#download">ğŸ“ Download Reports</a>
            </div>
            
            <div id="ui" class="section">
                <h2>ğŸ¨ UI Test Results</h2>
                <p>Download UI test reports from the Artifacts section.</p>
            </div>
            
            <div id="api" class="section">
                <h2>ğŸ”Œ API Test Results</h2>
                <p>Download API test reports from the Artifacts section.</p>
            </div>
            
            <div id="download" class="section">
                <h2>ğŸ“ Available Reports</h2>
                <ul>
                    <li><strong>UI Test Reports:</strong> ui-test-reports artifact</li>
                    <li><strong>API Test Reports:</strong> api-test-reports artifact</li>
                    <li><strong>Combined Archive:</strong> See Artifacts section below</li>
                </ul>
            </div>
        </body>
        </html>
        EOF
        
        # Create combined zip
        zip -r combined-test-reports.zip combined-report/

    - name: Upload Combined Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: combined-test-reports
        path: |
          combined-report/
          combined-test-reports.zip
        retention-days: 30

    - name: Generate Final Summary
      if: always()
      run: |
        echo "## ğŸ“Š Test Execution Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ‰ All tests have been executed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ Available Reports:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **UI Test Reports** - Download from Artifacts: \`ui-test-reports\`" >> $GITHUB_STEP_SUMMARY
        echo "2. **API Test Reports** - Download from Artifacts: \`api-test-reports\`" >> $GITHUB_STEP_SUMMARY
        echo "3. **Combined Report** - Download from Artifacts: \`combined-test-reports\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ” How to Download:" >> $GITHUB_STEP_SUMMARY
        echo "1. Go to the 'Actions' tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Click on this workflow run" >> $GITHUB_STEP_SUMMARY
        echo "3. Scroll down to the 'Artifacts' section" >> $GITHUB_STEP_SUMMARY
        echo "4. Click on any artifact to download" >> $GITHUB_STEP_SUMMARY
